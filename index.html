<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="js/svgexport.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>

    <style>
        
        #chart {
            font-size: 18px;
            padding-left: 20px;
            padding-top: 50px;
            padding-bottom: 60px;
        }
        #titlebar {
				width: calc(80% - 90px);
				height: 20px;
            border-bottom: ridge;
            border-color: #03F;
            padding-bottom: 5px;
            margin-left: 40px;
            margin-top: 5px;
            position: fixed;
            z-index: 50;
        }
        .node rect {
            fill-opacity: .9;
            shape-rendering: crispEdges;
        }
        .node text {
            pointer-events: none;
        }
        .link {
            fill: none;
            stroke: #000;
            stroke-opacity: .12;
        }
        .gradient-link {
            fill: none;
            stroke-opacity: .5;
        }
        h1 {
            font-size: 1.4rem;
        }
    </style>

</head>

<body>


    <div id="titlebar">
		<span id="titletext" class="pagetitle">Intel Nervana Neural Network Designer</span>
        <span id="titletext" class="pagetitle" style="positions:relative;float:right;right:30px;top:0px;"><a href="https://www.intelnervana.com/" target="_blank">Help</a>&nbsp;|
		<span id="titletext" class="pagetitle"><a href="#" onclick="alert('Intel Nervana Neural Network Designer by Tony Reina;\nBased on the Sankey plugin for D3 by Mike Bostock (https://bost.ocks.org/mike/);\nMIT License, 2014.');">Cite</a></span>
    </div>
	
    <div id="chart" style="positions:relative;float:left;"/>

    <script src="js/sankey.js"></script>
    <script>
        var margin = {
                top: 10,
                right: 100,
                bottom: 150,
                left: 10
            },
            width = window.innerWidth - margin.left - margin.right,
            height = window.innerHeight - margin.top - margin.bottom;

        var formatNumber = d3.format(",.2f"),
            format = function(d) {
                return formatNumber(d);
            },
            color = d3.scale.category20();

        var svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var sankey = d3.sankey()
            .nodeWidth(36)
            .nodePadding(50)
            .size([width, height]);

        var path = sankey.link();

        d3.json("network.json", function(energy) {

            sankey
                .nodes(energy.nodes)
                .links(energy.links)
                .layout(32);

            function setDash(d) {
                var d3this = d3.select(this);
                var totalLength = d3this.node().getTotalLength();
                d3this
                    .attr('stroke-dasharray', totalLength + ' ' + totalLength)
                    .attr('stroke-dashoffset', totalLength)
            }

            function branchAnimate(nodeData) {
                    var links = svg.selectAll(".gradient-link")
                        .filter(function(gradientD) {
                            return nodeData.sourceLinks.indexOf(gradientD) > -1
                        });
                    var nextLayerNodeData = [];
                    links.each(function(d) {
                        nextLayerNodeData.push(d.target);
                    });

                    links
                        .style("opacity", null)
                        .transition()
                        .duration(400)
                        .ease('linear')
                        .attr('stroke-dashoffset', 0)
                        .each("end", function() {
                            nextLayerNodeData.forEach(function(d) {
                                branchAnimate(d);
                            });
                        });
                } //end branchAnimate

            var gradientLink = svg.append("g").selectAll(".gradient-link")
                .data(energy.links)
                .enter().append("path")
                .attr("class", "gradient-link")
                .attr("d", path)
                .style("stroke-width", function(d) {
                    return Math.max(1, d.dy);
                })
                .sort(function(a, b) {
                    return b.dy - a.dy;
                })
                .each(setDash)
                .style('stroke', function(d) {
                    var sourceColor = color(d.source.name.replace(/ .*/, "")).replace("#", "");
                    var targetColor = color(d.target.name.replace(/ .*/, "")).replace("#", "");
                    var id = 'c-' + sourceColor + '-to-' + targetColor;
                    if (!svg.select(id)[0][0]) {
                        //append the gradient def
                        //append a gradient
                        var gradient = svg.append('defs')
                            .append('linearGradient')
                            .attr('id', id)
                            .attr('x1', '0%')
                            .attr('y1', '0%')
                            .attr('x2', '100%')
                            .attr('y2', '0%')
                            .attr('spreadMethod', 'pad');

                        gradient.append('stop')
                            .attr('offset', '0%')
                            .attr('stop-color', "#" + sourceColor)
                            .attr('stop-opacity', 1);

                        gradient.append('stop')
                            .attr('offset', '100%')
                            .attr('stop-color', "#" + targetColor)
                            .attr('stop-opacity', 1);
                    }
                    return "url(#" + id + ")";
                });

            var link = svg.append("g").selectAll(".link")
                .data(energy.links)
                .enter().append("path")
                .attr("class", "link")
                .attr("d", path)
                .style("stroke-width", function(d) {
                    return Math.max(1, d.dy);
                })
                .sort(function(a, b) {
                    return b.dy - a.dy;
                });

            link.append("title")
                .text(function(d) {
                    return d.source.name + " : " + d.target.name + "\n" + format(d.value);
                });


            var node = svg.append("g").selectAll(".node")
                .data(energy.nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", function(d) {
                    return "translate(" + d.x + "," + d.y + ")";
                })
                .on("mouseover", branchAnimate)
                .on("mouseout", function() {
                    //cancel all transitions by making a new one
                    gradientLink.transition();
                    gradientLink
                        .style("opacity", 0)
                        .each(function(d) {
                            setDash.call(this, d);
                        });
                })
                .call(d3.behavior.drag()
                .origin(function(d) { return d; })
                .on("dragstart", function() { 
		          this.parentNode.appendChild(this); })
                .on("drag", dragmove));
      

            node.append("rect")
                .attr("height", function(d) {
                    return d.dy;
                })
                .attr("width", sankey.nodeWidth())
                .style("fill", function(d) {
                    return d.color = color(d.name.replace(/ .*/, ""));
                })
                .append("title")
                .text(function(d) {
                    return d.name
                    + "\n=======" 
                    + "\n# inputs = " 
                    + (d.targetLinks.length) 
                    + "\n# outputs = "
                    + (d.sourceLinks.length) 
                    + "\nWeight = "+ format(d.value);
                });

node.append("text") //node
		.attr("x", function(i) {return -i.dy / 2})
		.attr("y", function(i) {return i.dx / 2 + 9})
		.attr("transform", "rotate(270)").attr("text-anchor", "middle").attr("font-size","23px").text(function(i) {
				return i.name;	
		})
		.attr("stroke",function(d){
			return d3.rgb(d["color"]).darker(2)
		}).attr("stroke-width","1px");
		
           
            // the function for moving the nodes
		  function dragmove(d) {
		    d3.select(this).attr("transform", 
		        "translate(" + (
		        	   d.x = Math.max(0, Math.min(width - d.dx, d3.event.x))
		        	) + "," + (
		                   d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
		            ) + ")");
		    
		    link.attr("d", path);
		    gradientLink.attr("d", path);
		    sankey.relayout();
		  }


        });
        
    </script>

</body>

</html>
